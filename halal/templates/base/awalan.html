{% load static %}
<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Haltrack — Sistem Keterlacakan Halal</title>
<style>
  :root{
    --bg:#0b0f12; --bg-2:#12171c; --card:#0f1419; --mute:#97a3b6;
    --brand:#11c09f; --brand-2:#39e5c0; --text:#ecf1f7; --accent:#ffd66e;
    --ring: 0 0 0 3px rgba(17,192,159,.25);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
  a{color:inherit;text-decoration:none}
  html{
  scroll-behavior: smooth;         /* bikin scroll halus */
  scroll-padding-top: 80px;        /* jarak aman supaya tidak ketutup header sticky */
}
  .wrap{max-width:1200px;margin:0 auto;padding:0 20px}
  header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#0b0f12,rgba(11,15,18,.65));backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
  .nav{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
  .brand{display:flex;gap:10px;align-items:center;font-weight:700}
  .brand .logo{width:34px;height:34px;border-radius:50%;background:conic-gradient(from 180deg,var(--brand),var(--brand-2));display:grid;place-items:center;color:#001b16;font-size:18px}
  .nav a.btn{padding:.55rem .9rem;border-radius:999px;background:var(--brand);color:#032d24;font-weight:700;box-shadow:0 10px 18px rgba(17,192,159,.18)}
  .hero{padding:72px 0 36px;background:
    radial-gradient(1200px 500px at 50% -40%,rgba(17,192,159,.25),transparent 60%),
    linear-gradient(#0b0f12,#0b0f12)}
  .hero h1{font-size:clamp(28px,5vw,44px);line-height:1.15;margin:0 0 10px}
  .hero p.lead{color:var(--mute);margin:0 0 28px}
  .searchbar{display:flex;align-items:center;gap:8px;max-width:760px;padding:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:999px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.02)}
  .searchbar:focus-within{box-shadow:var(--ring)}
  .searchbar input{
    flex:1;border:0;outline:0;background:transparent;color:var(--text);
    padding:.9rem 1rem;font-size:16px;min-width:0;
  }
  .searchbar button{
    border:0;outline:0;cursor:pointer;border-radius:999px;
    background:linear-gradient(135deg,var(--brand),var(--brand-2));
    padding:.7rem .95rem;display:grid;place-items:center;color:#00392f;
  }
  .hint{font-size:.9rem;color:var(--mute);margin-top:10px}
  .pill{display:inline-flex;align-items:center;gap:8px;margin-top:10px;
    padding:.45rem .7rem;border-radius:999px;background:#0e151a;border:1px solid rgba(255,255,255,.08);color:#bfeee6}
  section{padding:42px 0}
  .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:18px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;overflow:hidden}
  .card img{width:100%;height:160px;object-fit:cover}
  .card .p{padding:16px}
  .card h3{margin:0 0 6px;font-size:18px}
  .about{background:var(--bg-2);border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06)}
  .about .cols{display:grid;grid-template-columns:2fr 1fr;gap:20px}
  .badge-row{display:flex;gap:14px;flex-wrap:wrap;margin-top:14px}
  .badge{padding:.4rem .7rem;border-radius:999px;background:#0e151a;border:1px solid rgba(255,255,255,.08);font-size:.9rem;color:#d7e6ff}
  footer{padding:28px 0;color:var(--mute);font-size:.95rem}
  .about-kami { padding: 56px 0; background: linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%); }
.about-title { text-align:center; margin:0 0 12px; font-size:clamp(28px,4vw,40px); }
.about-desc  { text-align:center; color:var(--mute); max-width:900px; margin:0 auto 18px; }
.about-divider { border: none; border-top:1px solid rgba(255,255,255,.12); margin:24px 0; }
.about-grid { display:grid; grid-template-columns: 1.2fr 1fr; gap:24px; align-items:start; }
.about-logos { display:flex; gap:16px; flex-wrap:wrap; }
.about-logo { width:110px; height:110px; object-fit:cover; border-radius:12px; background:#fff; padding:8px; }
.about-contacts { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:16px; }
.about-contacts a { color: var(--brand-2); text-decoration: underline; }
/* wadah untuk memusatkan QR */
.p-qr{
  display:flex;
  align-items:center;
  justify-content:center;
  background:#fff;           /* QR kontras & tidak transparan */
  padding:16px;
}

/* override aturan global .card img */
.card img.qr-img{
  width:auto;                /* jangan paksa full width */
  height:auto;
  max-width:180px;           /* batas ukuran */
  max-height:180px;          /* jaga tetap kotak */
  object-fit:contain;        /* tidak terpotong */
  image-rendering:pixelated; /* QR lebih tajam */
  border-radius:8px;
  display:block;
}

@media (max-width:900px){
  .about-grid{ grid-template-columns:1fr; }
  .about-contacts{ grid-template-columns:1fr; }
  .about-logo{ width:96px; height:96px; }
  .about .cols{grid-template-columns:1fr}
}
  /* Visually-hidden file input */
  input[type="file"].visually-hidden{
    position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0
  }
  .qr-icon{width:20px;height:20px}
  
</style>
</head>
<body>
<header>
  <div class="wrap nav">
    <div class="brand">
      <img class="logo-img"
           src="{% static 'asset_awal/images/halal_2.png' %}"
           alt="Haltrack Logo" style="width:35px;height:35px;">
      <span>Haltrack</span>
    </div>
    <nav style="display:flex;gap:18px;align-items:center">
      <a href="#">Beranda</a><a href="#manfaat">Manfaat</a><a href="#tentang">Tentang</a><a href="#tentang">Kontak</a>
      <a class="btn" href="#">Login</a>
    </nav>
  </div>
</header>

<main>
  <section class="hero">
    <div class="wrap">
      <h1>Selamat datang di <span style="color:var(--brand-2)">Sistem Keterlacakan Halal</span></h1>
      <p class="lead">Lacak status halal produk UMKM dari sumbernya — ketik kata kunci atau unggah gambar QR.</p>

<form class="searchbar" id="search-form"
      action="{% url 'awal' %}" method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <input id="q" name="q" type="text" placeholder="Masukkan ID Produk" autocomplete="off" value="{{ nama_produk }}" />
  <button type="button" id="qr-btn" title="Unggah gambar QR"> <!-- QR icon (inline SVG) --> <svg class="qr-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"> <path d="M3 3h8v8H3V3zm2 2v4h4V5H5zm6-2h8v8h-8V3zm2 2v4h4V5h-4zM3 13h8v8H3v-8zm2 2v4h4v-4H5zm10-2h2v2h-2v-2zm4 0h2v4h-2v-4zm-4 4h2v2h-2v-2zm0 4h6v2h-6v-2z"/> </svg> </button>
  <input id="qr-file" class="visually-hidden" type="file" name="qr_file" accept="image/*"/>
  <canvas id="qrCanvas" style="display:none"></canvas>
</form>
      <div class="hint">Tip: klik ikon QR untuk unggah gambar QR. Jika didukung browser, isinya akan terbaca otomatis.</div>
      <div id="qr-result" class="pill" style="display:none"></div>
    </div>
  </section>
{% if getproduk %}
<section> <div class="wrap"> <div class="grid"> <article class="card">
  <div class="p-qr">
    <img src="{{ getproduk.qr_code }}" alt="QR {{ getproduk.nama_produk }}" class="qr-img">
  </div>
  <div class="p">
    <h3>{{ getproduk.nama_produk }}</h3>
    <div style="color:var(--mute)">UMKM: {{ getproduk.id_manufaktur.nama_usaha }}</div>
    <div>ID Produk: {{ getproduk.id_produk }}</div>
  </div>
</article>
</div> </div> </section>

{% endif %}
  <section id="manfaat">
    <div class="wrap">
      <h2 style="margin:0 0 14px">Mengapa <span style="color:var(--accent)">Keterlacakan Halal</span> Penting?</h2>
      <div class="grid">
        <article class="card">
          <img src="{% static 'asset_awal/images/belanja.jpg' %}" alt="">
          <div class="p">
            <h3>Kepastian & Transparansi</h3>
            <p>Informasi sumber bahan baku yang jelas membantu konsumen memilih produk dengan tenang.</p>
          </div>
        </article>
        <article class="card">
          <img src="{% static 'asset_awal/images/bb.jpg' %}" alt="">
          <div class="p">
            <h3>Kontrol Kepatuhan Produsen</h3>
            <p>Produsen memantau status kehalalan secara periodik untuk menjaga kepercayaan pelanggan.</p>
          </div>
        </article>
        <article class="card">
          <img src="{% static 'asset_awal/images/mabar.jpg' %}" alt="">
          <div class="p">
            <h3>Penerapan Halalan Thayyiban</h3>
            <p>Menjaga kualitas dari hulu ke hilir: bahan, proses, distribusi, hingga sampai ke konsumen.</p>
          </div>
        </article>
      </div>
    </div>
  </section>
<section id="tentang" class="about about-kami">
  <div class="wrap">
    <h2 class="about-title">Tentang <span style="color:var(--accent)">Kami</span></h2>
    <p class="about-desc">
      Sistem ini dikembangkan oleh Lembaga Pemeriksa Halal Universitas Brawijaya (LPH UB)
      bersama tim peneliti/mahasiswa Departemen Teknik Industri UB untuk membantu auditor, UMKM,
      dan konsumen memperoleh informasi keterlacakan halal yang cepat, akurat, dan mudah dipahami.
    </p>

    <hr class="about-divider" />

    <div class="about-grid">
      <!-- 3 logo -->
      <div class="about-logos">
        <img src="{% static 'asset_awal/images/ub.png' %}"   alt="Universitas Brawijaya" class="about-logo">
        <img src="{% static 'asset_awal/images/bank.png' %}" alt="Bank Indonesia"         class="about-logo">
        <img src="{% static 'asset_awal/images/halal.png' %}" alt="Halal Indonesia"       class="about-logo">
      </div>

      <!-- kontak -->
      <div class="about-contacts">
        <div>
          <strong>Alamat</strong><br>
          Gedung LRT UB, Jl. Veteran, Ketawanggede, Kec. Lowokwaru,<br>
          Kota Malang, Jawa Timur 65145
        </div>
        <div>
          <strong>Kunjungi Kami</strong><br>
          <a href="#" target="_blank" rel="noopener">Instagram</a><br>
          <a href="#" target="_blank" rel="noopener">Tiktok</a>
        </div>
        <div>
          <strong>Telepon</strong><br>
          0851-8300-5335
        </div>
        <div>
          <strong>Email</strong><br>
          lphub@ub.ac.id
        </div>
      </div>
    </div>
  </div>
</section>
</main>

<footer>
  <div class="wrap">© 2025 Haltrack. Semua hak cipta dilindungi.</div>
</footer>

<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script>
  const form     = document.getElementById('search-form');
  const qrBtn    = document.getElementById('qr-btn');
  const qrFile   = document.getElementById('qr-file');
  const inputQ   = document.getElementById('q');
  const resultEl = document.getElementById('qr-result');

  const canvas = document.getElementById('qrCanvas');
  const ctx    = canvas.getContext('2d');

  qrBtn.addEventListener('click', () => qrFile.click());

  // Enter untuk submit manual
  inputQ.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') form.submit();
  });

  // Helper: gambar image ke canvas dengan skala maksimum biar cepat
  async function drawToCanvas(file){
    const img = new Image();
    const url = URL.createObjectURL(file);
    await new Promise((res, rej) => {
      img.onload = res;
      img.onerror = rej;
      img.src = url;
    });
    // batasi sisi terpanjang 1200 px agar performa oke
    const maxSide = 1200;
    let { width, height } = img;
    const scale = Math.min(1, maxSide / Math.max(width, height));
    width  = Math.round(width  * scale);
    height = Math.round(height * scale);

    canvas.width = width;
    canvas.height = height;
    ctx.drawImage(img, 0, 0, width, height);
    URL.revokeObjectURL(url);
    return ctx.getImageData(0, 0, width, height);
  }

  function showResult(text){
    resultEl.textContent = text;
    resultEl.style.display = 'inline-flex';
  }

  // Decode gambar dengan jsQR. Coba beberapa rotasi ringan jika perlu.
  function tryDecodeWithRotations(imageData){
    // Percobaan utama
    let res = jsQR(imageData.data, imageData.width, imageData.height);
    if (res && res.data) return res.data;

    // Coba rotasi 90/180/270 derajat jika gagal
    const rotations = [90, 180, 270];
    for (const deg of rotations){
      const rotated = rotateImageData(imageData, deg);
      res = jsQR(rotated.data, rotated.width, rotated.height);
      if (res && res.data) return res.data;
    }
    return '';
  }

  // Utility rotasi sederhana
  function rotateImageData(src, deg){
    const dstCanvas = document.createElement('canvas');
    const dctx = dstCanvas.getContext('2d');
    if (deg === 90 || deg === 270){
      dstCanvas.width  = src.height;
      dstCanvas.height = src.width;
    } else {
      dstCanvas.width  = src.width;
      dstCanvas.height = src.height;
    }
    dctx.save();
    dctx.translate(dstCanvas.width / 2, dstCanvas.height / 2);
    dctx.rotate((deg * Math.PI) / 180);
    dctx.drawImage(canvas, -canvas.width / 2, -canvas.height / 2);
    dctx.restore();
    const out = dctx.getImageData(0, 0, dstCanvas.width, dstCanvas.height);
    return out;
  }

  // Setelah pilih file -> decode dengan jsQR, isi input, lalu submit
  qrFile.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    try {
      const imageData = await drawToCanvas(file);
      let decoded = tryDecodeWithRotations(imageData);

      // fallback: BarcodeDetector (kalau ada) — kadang lebih beruntung
      if (!decoded && 'BarcodeDetector' in window) {
        try {
          const bmp = await createImageBitmap(file);
          const detector = new BarcodeDetector({ formats: ['qr_code'] });
          const codes = await detector.detect(bmp);
          if (codes && codes.length) decoded = codes[0].rawValue || '';
        } catch {}
      }

      if (decoded) {
        inputQ.value = decoded;
        showResult(`QR terbaca: ${decoded}`);
        form.submit();
      } else {
        showResult('QR tidak terbaca. Coba foto yang lebih tajam/kontras.');
      }
    } catch (err) {
      console.error(err);
      showResult('Gagal memproses gambar.');
    }
  });
</script>
</body>
</html>
